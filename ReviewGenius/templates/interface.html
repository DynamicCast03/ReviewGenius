<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ReviewGenius - 智能出题</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
		<style>
			body {
				background-color: #f8f9fa;
			}
			.container {
				max-width: 1200px;
			}
			.card-header strong {
				font-size: 1.1rem;
			}
		</style>
	</head>
	<body>
		<div class="container mt-5">
			<div class="text-center mb-5 d-flex justify-content-center align-items-center">
				<h1 class="me-3">ReviewGenius 智能出题系统</h1>
				<button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
					<i class="bi bi-gear"></i>
				</button>
			</div>

			<div class="row g-5">
				<div class="col-md-4">
					<form id="generate-form">
						<input type="hidden" id="temperature" name="temperature" value="1.0">
						<div class="mb-3">
							<label for="file-upload" class="form-label fw-bold"
								>1. 上传学习材料</label
							>
							<input
								type="file"
								class="form-control"
								id="file-upload"
								name="file0"
								required
							/>
						</div>
						<div class="mb-3">
							<label for="api_key" class="form-label fw-bold"
								>2. 输入API Key</label
							>
							<input
								type="password"
								class="form-control"
								id="api_key"
								name="api_key"
								placeholder="请输入 SiliconFlow API Key"
								required
							/>
						</div>
						<div class="mb-3">
							<label for="user_input" class="form-label fw-bold"
								>3. 输入额外要求 (可选)</label
							>
							<textarea
								class="form-control"
								id="user_input"
								name="user_input"
								rows="3"
								placeholder="例如：请侧重于XX章节的知识点"
							></textarea>
						</div>
						<div class="mb-4">
							<label class="form-label fw-bold">4. 设置题型和数量</label>
							<div class="row g-2 mb-2">
								<div class="col">
									<label for="choice_count" class="form-label"
										>选择题</label
									>
									<input
										type="number"
										class="form-control"
										id="choice_count"
										name="choice_count"
										value="2"
										min="0"
									/>
								</div>
								<div class="col">
									<label for="blank_count" class="form-label"
										>填空题</label
									>
									<input
										type="number"
										class="form-control"
										id="blank_count"
										name="blank_count"
										value="2"
										min="0"
									/>
								</div>
								<div class="col">
									<label for="short_count" class="form-label"
										>简答/计算题</label
									>
									<input
										type="number"
										class="form-control"
										id="short_count"
										name="short_count"
										value="1"
										min="0"
									/>
								</div>
							</div>
							<div class="row g-2">
								<div class="col">
									<label for="choice_score" class="form-label">分值</label>
									<input type="number" class="form-control" id="choice_score" name="choice_score" value="5" min="1">
								</div>
								<div class="col">
									<label for="blank_score" class="form-label">分值</label>
									<input type="number" class="form-control" id="blank_score" name="blank_score" value="5" min="1">
								</div>
								<div class="col">
									<label for="short_score" class="form-label">分值</label>
									<input type="number" class="form-control" id="short_score" name="short_score" value="10" min="1">
								</div>
							</div>
						</div>
						<button
							type="submit"
							class="btn btn-primary w-100 btn-lg"
							id="generate-btn"
						>
							<span
								class="spinner-border spinner-border-sm d-none"
								role="status"
								aria-hidden="true"
							></span>
							生成试卷
						</button>
					</form>
				</div>

				<div class="col-md-8">
					<h4>生成的题目</h4>
					<div
						id="questions-container"
						class="mt-3"
						style="min-height: 400px"
					>
						<!-- 流式生成的卡片将出现在这里 -->
						<div
							class="alert alert-secondary text-center"
							id="start-generation-placeholder"
						>
							点击"生成试卷"开始出题
						</div>
					</div>
					<div id="controls-container" class="mt-3 text-center"></div>
				</div>
			</div>
		</div>

		<!-- Settings Modal -->
		<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="settingsModalLabel">设置</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<label for="temperature-slider" class="form-label">模型 Temperature: <span id="temperature-value">1.0</span></label>
							<p class="form-text text-muted small">较低的值（如 0.2）会使输出更具确定性和一致性。较高的值（如 1.0）会带来更多的多样性和创造性。</p>
							<input type="range" class="form-range" id="temperature-slider" min="0" max="2" step="0.1" value="1.0">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" id="save-settings">保存设置</button>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				// API Key记忆功能
				const apiKeyInput = document.getElementById('api_key');
				const savedApiKey = localStorage.getItem('siliconflow_api_key');
				if (savedApiKey) {
					apiKeyInput.value = savedApiKey;
				}

				apiKeyInput.addEventListener('input', function() {
					localStorage.setItem('siliconflow_api_key', apiKeyInput.value);
				});

				// Settings Modal Logic
				const temperatureSlider = document.getElementById('temperature-slider');
				const temperatureValueSpan = document.getElementById('temperature-value');
				const saveSettingsBtn = document.getElementById('save-settings');
				const temperatureInput = document.getElementById('temperature');
				const settingsModalEl = document.getElementById('settingsModal');
				const settingsModal = new bootstrap.Modal(settingsModalEl);


				// Load saved temperature or use default
				let currentTemperature = localStorage.getItem('llm_temperature') || '0.7';
				temperatureSlider.value = currentTemperature;
				temperatureValueSpan.textContent = currentTemperature;
				temperatureInput.value = currentTemperature;

				// Update span when slider is moved
				temperatureSlider.addEventListener('input', function() {
					temperatureValueSpan.textContent = temperatureSlider.value;
				});

				// Save settings when button is clicked
				saveSettingsBtn.addEventListener('click', function() {
					const newTemperature = temperatureSlider.value;
					localStorage.setItem('llm_temperature', newTemperature);
					temperatureInput.value = newTemperature;
					console.log('Temperature saved:', newTemperature);
					settingsModal.hide();
				});
			});

			let generatedQuestions = []; // 全局变量存储生成的题目

			function formatQuestion(data) {
				const typeMap = {
					multiple_choice: "选择题",
					fill_in_the_blank: "填空题",
					short_answer: "简答题",
				};
				const questionTypeName = typeMap[data.question_type] || "未知题型";

				let content = `<p><strong>题型：</strong>${questionTypeName}</p>`;

				if (data.stem) {
					content += `<p><strong>题目：</strong>${data.stem.replace(
						/___/g,
						'<u style="padding: 0 1em;">&nbsp;&nbsp;&nbsp;</u>'
					)}</p>`;
				}

				if (data.question_type === "multiple_choice" && data.options) {
					content += '<p><strong>选项：</strong></p><ul class="list-group list-group-flush">';
					for (const [key, value] of Object.entries(data.options)) {
						content += `<li class="list-group-item">${key}. ${value}</li>`;
					}
					content += "</ul>";
				}
				return content;
			}

			function createQuestionCard(data, question_number) {
				const card = document.createElement('div');
				card.className = 'card mb-3 shadow-sm';
				card.style.opacity = "0";
                card.style.transform = "translateY(20px)";
                card.style.transition = "opacity 0.5s ease, transform 0.5s ease";

				let answerContent = '';
				let answerHtml = "";
				if (Array.isArray(data.answer)) {
					answerHtml = data.answer.join(", ");
				} else {
					answerHtml = data.answer;
				}

				if (answerHtml) {
					answerContent = `<p><strong>答案：</strong>${answerHtml}</p>`;
				}
				if (data.explanation) {
					answerContent += `<p><strong>解析：</strong>${data.explanation}</p>`;
				}

				card.innerHTML = `
					<div class="card-header d-flex justify-content-between align-items-center">
						<strong>题目 ${question_number}</strong>
						<span class="badge bg-secondary">${data.score}分</span>
					</div>
					<div class="card-body">
						${formatQuestion(data)}
						<button class="btn btn-info btn-sm mt-2 toggle-answer" data-bs-toggle="collapse" data-bs-target="#answer-${question_number}" aria-expanded="false" aria-controls="answer-${question_number}">
							显示答案
						</button>
						<div class="collapse" id="answer-${question_number}">
							<div class="card card-body mt-2 bg-light">
								${answerContent}
							</div>
						</div>
					</div>
				`;

				const toggleButton = card.querySelector('.toggle-answer');
				toggleButton.addEventListener('click', function() {
					this.textContent = this.textContent.includes('显示') ? '隐藏答案' : '显示答案';
				});

				setTimeout(() => {
                    card.style.opacity = "1";
                    card.style.transform = "translateY(0)";
                }, 10);

				return card;
			}

			function startPractice() {
                const formContainer = document.querySelector(".col-md-4");
                const questionsContainer = document.getElementById("questions-container");
                const controlsContainer = document.getElementById("controls-container");

                formContainer.style.display = "none"; // 隐藏表单
                questionsContainer.innerHTML = ""; // 清空题目预览
                controlsContainer.innerHTML = ""; // 清空"开始练习"按钮

                document.querySelector(".col-md-8").classList.replace("col-md-8", "col-md-12"); // 扩展宽度

                const practiceTitle = document.createElement("h4");
                practiceTitle.textContent = "在线练习";
                questionsContainer.appendChild(practiceTitle);


                generatedQuestions.forEach((q, index) => {
                    const card = createPracticeCard(q, index + 1);
                    questionsContainer.appendChild(card);
                });

				const submitBtn = document.createElement('button');
				submitBtn.id = 'submit-practice-btn';
				submitBtn.className = 'btn btn-success btn-lg mt-4';
				submitBtn.textContent = '提交批改';
				submitBtn.addEventListener('click', submitForGrading);
				questionsContainer.appendChild(submitBtn);
            }

			function createPracticeCard(data, question_number) {
				const card = document.createElement('div');
				card.className = 'card mb-3 shadow-sm practice-card';
				card.dataset.questionIndex = question_number - 1;

				let questionContent = '';
				const typeMap = {
					multiple_choice: "选择题",
					fill_in_the_blank: "填空题",
					short_answer: "简答题",
				};
				const questionTypeName = typeMap[data.question_type] || "未知题型";

				let answerArea = '';
				if (data.question_type === 'multiple_choice') {
					answerArea += '<ul class="list-group list-group-flush">';
					for (const [key, value] of Object.entries(data.options)) {
						answerArea += `<li class="list-group-item">
							<input class="form-check-input me-1" type="radio" name="mcq-${question_number}" id="mcq-${question_number}-${key}" value="${key}">
							<label class="form-check-label" for="mcq-${question_number}-${key}">${key}. ${value}</label>
						</li>`;
					}
					answerArea += '</ul>';
				} else if (data.question_type === 'fill_in_the_blank') {
					let blank_count = 0;
					const stemWithInputs = data.stem.replace(/___/g, () => {
						blank_count++;
						return `<input type="text" class="form-control d-inline-block fitb-input" style="width: 150px; margin: 0 5px;" data-blank-index="${blank_count-1}">`;
					});
					questionContent = `<p><strong>题目：</strong>${stemWithInputs}</p>`;
				} else if (data.question_type === 'short_answer') {
					answerArea = `<textarea class="form-control" rows="5" placeholder="在此输入你的答案..."></textarea>`;
				}


				card.innerHTML = `
					<div class="card-header d-flex justify-content-between align-items-center">
						<div><strong>题目 ${question_number} (${questionTypeName})</strong></div>
						<span class="badge bg-secondary">${data.score}分</span>
					</div>
					<div class="card-body">
						${questionContent || `<p><strong>题目：</strong>${data.stem}</p>`}
						<div class="answer-area mt-3">${answerArea}</div>
						<div class="result-area mt-3" style="display: none;"></div>
					</div>
				`;
				return card;
			}

			function collectUserAnswers() {
				const userAnswers = [];
				const practiceCards = document.querySelectorAll('.practice-card');

				practiceCards.forEach((card, index) => {
					const question = generatedQuestions[index];
					let answer;
					if (question.question_type === 'multiple_choice') {
						const checked = card.querySelector('input[type="radio"]:checked');
						answer = checked ? checked.value : null;
					} else if (question.question_type === 'fill_in_the_blank') {
						const inputs = card.querySelectorAll('.fitb-input');
						answer = Array.from(inputs).map(input => input.value);
					} else if (question.question_type === 'short_answer') {
						answer = card.querySelector('textarea').value;
					}
					userAnswers.push(answer);
				});
				return userAnswers;
			}

			async function submitForGrading() {
				const userAnswers = collectUserAnswers();
				const apiKey = localStorage.getItem('siliconflow_api_key');
				const temperature = localStorage.getItem('llm_temperature') || '0.7';

				// 禁用提交按钮
				const submitBtn = document.getElementById('submit-practice-btn');
				submitBtn.disabled = true;
				submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在初始化批改...';
				
				document.querySelectorAll('.practice-card input, .practice-card textarea').forEach(el => el.disabled = true);

				try {
					const response = await fetch('/api/grade', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							questions: generatedQuestions,
							answers: userAnswers,
							api_key: apiKey,
							temperature: parseFloat(temperature)
						})
					});
					
					if (!response.ok) {
						const errData = await response.json();
						throw new Error(errData.error || '批改服务连接失败');
					}
					
					submitBtn.style.display = 'none';

					const reader = response.body.getReader();
					const decoder = new TextDecoder();
					let buffer = "";
					let gradedCount = 0;

					while (true) {
						const { done, value } = await reader.read();
						if (done) break;

						buffer += decoder.decode(value, { stream: true });
						const lines = buffer.split("\\n");
						buffer = lines.pop();

						for (const line of lines) {
							if (line.trim()) {
								try {
									const event = JSON.parse(line);
									const card = document.querySelector(`.practice-card[data-question-index="${event.question_index}"]`);
									if (!card) continue;
									
									const resultArea = card.querySelector('.result-area');

									if (event.type === 'error') {
										resultArea.innerHTML = `<div class="alert alert-danger p-2"><strong>错误:</strong> ${event.error}</div>`;
										resultArea.style.display = 'block';
										gradedCount++;
									} else if (event.type === 'start') {
										resultArea.innerHTML = '<pre style="white-space: pre-wrap; word-wrap: break-word; color: #6c757d;"></pre>';
										resultArea.style.display = 'block';
									} else if (event.type === 'streaming') {
										const pre = resultArea.querySelector('pre');
										if (pre) pre.textContent += event.content;
									} else if (event.type === 'end') {
										displaySingleGradingResult(resultArea, event.data, generatedQuestions[event.question_index]);
										gradedCount++;
									}
								} catch (e) {
									console.error("解析或处理批改流时出错:", e);
								}
							}
						}
					}
					
					if (gradedCount === generatedQuestions.length) {
						displayOverallScore();
					}

				} catch(error) {
					alert(`提交批改时出错: ${error.message}`);
					submitBtn.style.display = 'block';
					submitBtn.disabled = false;
					submitBtn.textContent = '提交批改';
					document.querySelectorAll('.practice-card input, .practice-card textarea').forEach(el => el.disabled = false);
				}
			}

			function displaySingleGradingResult(resultArea, resultData, questionData) {
				const scoreColor = resultData.score === questionData.score ? 'text-success' : (resultData.score > 0 ? 'text-warning' : 'text-danger');
				let resultHtml = `
					<h5>批改结果</h5>
					<p><strong>得分: <span class="${scoreColor}">${resultData.score}</span> / ${questionData.score}</strong></p>
				`;

				if (questionData.question_type === 'multiple_choice') {
					resultHtml += `<p><strong>正确答案:</strong> ${questionData.answer}</p>`;
				} else {
					resultHtml += `<p><strong>参考答案:</strong> ${Array.isArray(questionData.answer) ? questionData.answer.join(', ') : questionData.answer}</p>`;
				}

				resultHtml += `<p><strong>AI点评:</strong> ${resultData.feedback}</p>`;
				resultArea.innerHTML = resultHtml;
			}
			
			function displayOverallScore() {
				let totalScore = 0;
				let earnedScore = 0;

				document.querySelectorAll('.practice-card').forEach((card, index) => {
					const question = generatedQuestions[index];
					totalScore += question.score;
					const scoreSpan = card.querySelector('.result-area span[class*="text-"]');
					if (scoreSpan) {
						earnedScore += parseInt(scoreSpan.textContent, 10) || 0;
					}
				});

				const overallResult = document.createElement('div');
				overallResult.className = 'alert alert-info mt-4';
				overallResult.innerHTML = `<h4>练习完成！</h4><p class="mb-0"><strong>总得分: ${earnedScore} / ${totalScore}</strong></p>`;
				document.getElementById('questions-container').appendChild(overallResult);
			}

			document
				.getElementById("generate-form")
				.addEventListener("submit", async function (event) {
					event.preventDefault();

					const generateBtn = document.getElementById("generate-btn");
					const spinner = generateBtn.querySelector(".spinner-border");
					const questionsContainer =
						document.getElementById("questions-container");
					const placeholder = document.getElementById(
						"start-generation-placeholder"
					);

					generateBtn.disabled = true;
					spinner.classList.remove("d-none");
					if (placeholder) {
						placeholder.remove();
					}
					questionsContainer.innerHTML =
						'<p class="text-center text-primary">正在连接模型，请稍候...</p>';

					const formData = new FormData(this);

					try {
						const response = await fetch("/api/process", {
							method: "POST",
							body: formData,
						});

						if (!response.ok) {
							const errorData = await response.json();
							throw new Error(
								errorData.error || `HTTP error! status: ${response.status}`
							);
						}

						questionsContainer.innerHTML = ""; // 清空等待提示
						generatedQuestions = []; // 重置题目

						const reader = response.body.getReader();
						const decoder = new TextDecoder();
						let buffer = "";
						let questionCounter = 1;
						let currentCard = null;
						let currentCardBody = null;

						while (true) {
							const { done, value } = await reader.read();
							if (done) {
								break;
							}

							buffer += decoder.decode(value, { stream: true });
							// \\n is used as a separator by the backend
							const lines = buffer.split("\\n");

							buffer = lines.pop(); // 保留可能不完整的行

							for (const line of lines) {
								if (line.trim()) {
									try {
										const event = JSON.parse(line);

										if (event.type === 'error') {
											throw new Error(event.error || '未知流错误');
										}

										if (event.type === 'start') {
											const cardId = `question-card-${questionCounter}`;
											const cardWrapper = document.createElement("div");
											cardWrapper.innerHTML = `
												<div id="${cardId}" class="card mb-3 shadow-sm">
													<div class="card-header">
														<strong>题目 ${questionCounter}</strong>
													</div>
													<div class="card-body">
														<pre style="white-space: pre-wrap; word-wrap: break-word;"></pre>
													</div>
												</div>
											`;
											currentCard = cardWrapper.firstElementChild;
											questionsContainer.appendChild(currentCard);
											currentCardBody = currentCard.querySelector('.card-body pre');
										} else if (event.type === 'streaming' && currentCardBody) {
											// 使用 textContent 来防止 HTML 注入
											currentCardBody.textContent += event.content;
											questionsContainer.scrollTop = questionsContainer.scrollHeight;
										} else if (event.type === 'end' && currentCard) {
											const finalData = event.data;
											generatedQuestions.push(finalData); // 存储题目数据
											// 使用现有的函数来格式化最终的卡片内容
											const finalCard = createQuestionCard(finalData, questionCounter);
											// 替换掉临时的流式卡片
											currentCard.replaceWith(finalCard);
											// 触发新卡的进入动画
											setTimeout(() => {
												finalCard.style.opacity = "1";
												finalCard.style.transform = "translateY(0)";
											}, 50);

											questionCounter++;
											currentCard = null; // 为下一张卡片重置
											currentCardBody = null;
										}
									} catch (e) {
										console.error("解析或处理流数据时出错:", e);
										// 可以在这里向用户显示一个通用错误
									}
								}
							}
						}
						// Handle any final text in buffer if necessary
						if (buffer.trim()) {
							console.log("Finished with non-empty buffer:", buffer);
						}

						// 全部题目加载完成后显示"开始练习"按钮
						const controlsContainer = document.getElementById("controls-container");
						const practiceBtn = document.createElement("button");
						practiceBtn.id = "start-practice-btn";
						practiceBtn.className = "btn btn-info btn-lg";
						practiceBtn.textContent = "开始练习";
						practiceBtn.onclick = startPractice;
						controlsContainer.innerHTML = "";
						controlsContainer.appendChild(practiceBtn);

					} catch (error) {
						questionsContainer.innerHTML = `<div class="alert alert-danger" role="alert"><strong>出错了:</strong> ${error.message}</div>`;
					} finally {
						generateBtn.disabled = false;
						spinner.classList.add("d-none");
					}
				});
		</script>
	</body>
</html>


